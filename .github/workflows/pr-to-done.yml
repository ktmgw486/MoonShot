name: Move PR Issues to Done

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - main

jobs:
  move-to-done:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Move linked issues to Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prNumber = pr.number;
            
            console.log(`üîÑ Processing merged PR #${prNumber}`);
            
            // Extract issue numbers from PR body
            const issueRegex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const matches = [...prBody.matchAll(issueRegex)];
            const issueNumbers = [...new Set(matches.map(match => parseInt(match[1])))];
            
            if (issueNumbers.length === 0) {
              console.log('‚ÑπÔ∏è No linked issues found in PR body');
              return;
            }
            
            console.log(`üìã Found linked issues: #${issueNumbers.join(', #')}`);
            
            // GraphQL query to get project info
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            // Get project information
            const projectResult = await github.graphql(projectQuery, {
              org: 'nb07-Moonshot-Team2',
              number: 1
            });
            
            const project = projectResult.organization.projectV2;
            const projectId = project.id;
            
            // Find Status field and Done option
            const statusField = project.fields.nodes.find(field => field.name === 'Status');
            if (!statusField) {
              console.error('‚ùå Status field not found in project');
              return;
            }
            
            const doneOption = statusField.options.find(option => option.name === 'Done');
            if (!doneOption) {
              console.error('‚ùå "Done" option not found in Status field');
              console.log('Available options:', statusField.options.map(o => o.name).join(', '));
              return;
            }
            
            console.log(`‚úÖ Found Status field (${statusField.id}) and Done option (${doneOption.id})`);
            
            // Process each issue
            for (const issueNumber of issueNumbers) {
              try {
                console.log(`\nüîÑ Processing issue #${issueNumber}...`);
                
                // Get issue node ID
                const issueResult = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                const issueNodeId = issueResult.data.node_id;
                
                // Check if issue is already in project
                const itemQuery = `
                  query($projectId: ID!, $issueId: ID!) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 100) {
                          nodes {
                            id
                            content {
                              ... on Issue {
                                id
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const itemResult = await github.graphql(itemQuery, {
                  projectId: projectId,
                  issueId: issueNodeId
                });
                
                let projectItemId = itemResult.node.items.nodes.find(
                  item => item.content && item.content.id === issueNodeId
                )?.id;
                
                // Add issue to project if not already added
                if (!projectItemId) {
                  console.log('  üìå Adding issue to project...');
                  const addMutation = `
                    mutation($projectId: ID!, $contentId: ID!) {
                      addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                        item {
                          id
                        }
                      }
                    }
                  `;
                  
                  const addResult = await github.graphql(addMutation, {
                    projectId: projectId,
                    contentId: issueNodeId
                  });
                  
                  projectItemId = addResult.addProjectV2ItemById.item.id;
                  console.log(`  ‚úÖ Issue added to project (${projectItemId})`);
                } else {
                  console.log(`  ‚úÖ Issue already in project (${projectItemId})`);
                }
                
                // Update status to Done
                console.log('  üîÑ Updating status to Done...');
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {singleSelectOptionId: $optionId}
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: projectItemId,
                  fieldId: statusField.id,
                  optionId: doneOption.id
                });
                
                console.log(`  ‚úÖ Issue #${issueNumber} status updated to Done`);
              } catch (error) {
                console.error(`  ‚ùå Error processing issue #${issueNumber}:`, error.message);
              }
            }
            
            console.log('\n‚úÖ All linked issues moved to Done');
