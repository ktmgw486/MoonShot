name: Backend Test Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-test.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test -d test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          DATABASE_URL="postgresql://test:test@localhost:5432/test"
          JWT_SECRET="test-jwt-secret-min-32-chars-long-for-security-purposes"
          JWT_REFRESH_SECRET="test-refresh-secret-min-32-chars-long-for-security"
          JWT_EXPIRES_IN="15m"
          JWT_REFRESH_EXPIRES_IN="7d"
          NODE_ENV="test"
          PORT=3000
          FRONTEND_URL="http://localhost:5173"
          CLOUDINARY_CLOUD_NAME="test-cloud"
          CLOUDINARY_API_KEY="test-key"
          CLOUDINARY_API_SECRET="test-secret"
          MAX_FILE_SIZE=5242880
          MAX_DOCUMENT_SIZE=10485760
          GOOGLE_CLIENT_ID="test-google-client-id"
          GOOGLE_CLIENT_SECRET="test-google-client-secret"
          GOOGLE_CALLBACK_URL="http://localhost:3000/auth/google/callback"
          EOF
      
      - name: Run Prisma migrate (db push)
        run: npm run db:push
      
      - name: Make test script executable
        run: chmod +x scripts/test.sh
      
      - name: Run test script
        run: ./scripts/test.sh
      
      - name: Send Discord notification on success
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "✅ Backend Tests Passed",
                "description": "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}",
                "color": 3066993,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${{ github.event.pull_request.user.login }}",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "${{ github.event.pull_request.head.ref }}",
                    "inline": true
                  }
                ],
                "url": "${{ github.event.pull_request.html_url }}",
                "timestamp": "${{ github.event.pull_request.updated_at }}"
              }]
            }'
      
      - name: Send Discord notification on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "❌ Backend Tests Failed",
                "description": "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${{ github.event.pull_request.user.login }}",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "${{ github.event.pull_request.head.ref }}",
                    "inline": true
                  }
                ],
                "url": "${{ github.event.pull_request.html_url }}",
                "timestamp": "${{ github.event.pull_request.updated_at }}"
              }]
            }'
